<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Email Scheduler</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  </head>
  <body>
    <div class="container">
      <h1>Email Scheduler</h1>

      <div class="tabs">
        <div class="tab active" onclick="switchTab('one-time')">
          <span class="material-symbols-outlined">schedule_send</span> One-Time Email
        </div>
        <div class="tab" onclick="switchTab('recurring')">
          <span class="material-symbols-outlined">repeat</span> Recurring Email
        </div>
        <div class="tab" onclick="switchTab('scheduled')">
          <span class="material-symbols-outlined">list</span> Scheduled Emails
        </div>
      </div>

      <div id="message-container"></div>

      <!-- One-Time Email Form -->
      <div id="one-time" class="tab-content active form-section">
        <h2>Schedule One-Time Email</h2>
        <form id="one-time-form">
          <div class="form-group">
            <label for="one-time-recipients">
              <span class="material-symbols-outlined">person</span> Recipients (comma separated)
            </label>
            <input
              type="text"
              id="one-time-recipients"
              placeholder="email1@example.com, email2@example.com"
              required
            />
          </div>

          <div class="form-group">
            <label for="one-time-subject">
              <span class="material-symbols-outlined">subject</span> Subject
            </label>
            <input
              type="text"
              id="one-time-subject"
              placeholder="Email Subject"
              required
            />
          </div>

          <div class="form-group">
            <label for="one-time-body">
              <span class="material-symbols-outlined">edit_note</span> Email Body
            </label>
            <textarea
              id="one-time-body"
              rows="5"
              placeholder="Email Content"
              required
            ></textarea>
          </div>

          <div class="form-group">
            <label for="one-time-date">
              <span class="material-symbols-outlined">calendar_month</span> Date (DD/MM/YYYY)
            </label>
            <input
              type="text"
              id="one-time-date"
              placeholder="DD/MM/YYYY"
              required
            />
          </div>

          <div class="form-group">
            <label for="one-time-time">
              <span class="material-symbols-outlined">schedule</span> Time (HH:MM:SS)
            </label>
            <input
              type="text"
              id="one-time-time"
              placeholder="HH:MM:SS"
              required
            />
          </div>

          <button type="submit">
            <span class="material-symbols-outlined">send</span> Schedule Email
          </button>
        </form>
      </div>

      <!-- Recurring Email Form -->
      <div id="recurring" class="tab-content form-section">
        <h2>Schedule Recurring Email</h2>
        <form id="recurring-form">
          <div class="form-group">
            <label for="recurring-recipients">
              <span class="material-symbols-outlined">person</span> Recipients (comma separated)
            </label>
            <input
              type="text"
              id="recurring-recipients"
              placeholder="email1@example.com, email2@example.com"
              required
            />
          </div>

          <div class="form-group">
            <label for="recurring-subject">
              <span class="material-symbols-outlined">subject</span> Subject
            </label>
            <input
              type="text"
              id="recurring-subject"
              placeholder="Email Subject"
              required
            />
          </div>

          <div class="form-group">
            <label for="recurring-body">
              <span class="material-symbols-outlined">edit_note</span> Email Body
            </label>
            <textarea
              id="recurring-body"
              rows="5"
              placeholder="Email Content"
              required
            ></textarea>
          </div>

          <div class="form-group">
            <label for="recurring-start-date">
              <span class="material-symbols-outlined">calendar_month</span> Start Date (DD/MM/YYYY)
            </label>
            <input
              type="text"
              id="recurring-start-date"
              placeholder="DD/MM/YYYY"
              required
            />
          </div>

          <div class="form-group">
            <label for="recurring-start-time">
              <span class="material-symbols-outlined">schedule</span> Start Time (HH:MM:SS)
            </label>
            <input
              type="text"
              id="recurring-start-time"
              placeholder="HH:MM:SS"
              required
            />
          </div>

          <div class="form-group">
            <label for="recurring-pattern">
              <span class="material-symbols-outlined">loop</span> Recurrence Pattern
            </label>
            <select id="recurring-pattern" required>
              <option value="daily">Daily</option>
              <option value="weekly">Weekly (Same day of week as start date)</option>
              <option value="weekly:0">Weekly (Sunday)</option>
              <option value="weekly:1">Weekly (Monday)</option>
              <option value="weekly:2">Weekly (Tuesday)</option>
              <option value="weekly:3">Weekly (Wednesday)</option>
              <option value="weekly:4">Weekly (Thursday)</option>
              <option value="weekly:5">Weekly (Friday)</option>
              <option value="weekly:6">Weekly (Saturday)</option>
              <option value="monthly">Monthly (Same day of month as start date)</option>
              <option value="yearly">Yearly (Same date each year)</option>
            </select>
          </div>

          <div class="form-group">
            <label for="recurring-end-date">
              <span class="material-symbols-outlined">event_busy</span> End Date (DD/MM/YYYY) (Optional)
            </label>
            <input
              type="text"
              id="recurring-end-date"
              placeholder="DD/MM/YYYY"
            />
          </div>

          <div class="form-group">
            <label for="recurring-end-time">
              <span class="material-symbols-outlined">timer_off</span> End Time (HH:MM:SS) (Optional)
            </label>
            <input type="text" id="recurring-end-time" placeholder="HH:MM:SS" />
          </div>

          <div class="form-group">
            <label for="recurring-max">
              <span class="material-symbols-outlined">numbers</span> Maximum Occurrences (Optional)
            </label>
            <input
              type="number"
              id="recurring-max"
              placeholder="Leave empty for unlimited"
            />
          </div>

          <button type="submit">
            <span class="material-symbols-outlined">send</span> Schedule Recurring Email
          </button>
        </form>
      </div>

      <!-- Scheduled Emails Section -->
      <div id="scheduled" class="tab-content form-section">
        <h2>Scheduled Emails</h2>
        <button id="refresh-jobs">
          <span class="material-symbols-outlined">refresh</span> Refresh List
        </button>
        <div class="scheduled-emails">
          <table id="jobs-table">
            <thead>
              <tr>
                <th>Job ID</th>
                <th>Type</th>
                <th>Next Scheduled Time</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody id="jobs-list">
              <!-- Jobs will be listed here -->
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <button class="chatbot-toggler">
      <span class="material-symbols-outlined">mode_comment</span>
      <span class="material-symbols-outlined">close</span>
    </button>
    
    <div class="chatbot">
      <header>
        <h2>Chatbot Assistant</h2>
        <span class="close-btn material-symbols-outlined">close</span>
      </header>
      <ul class="chatbox">
        <li class="chat incoming">
          <span class="material-symbols-outlined">smart_toy</span>
          <p>Hi there! ðŸ‘‹<br>How can I help you with your email scheduling today?</p>
        </li>
      </ul>
      <div class="chat-input">
        <textarea placeholder="Type your message here..." required></textarea>
        <span id="send-btn" class="material-symbols-outlined">send</span>
      </div>
    </div>

    <script src="script.js" defer></script>
    <script>
      // Switch between tabs
      function switchTab(tabId) {
        document
          .querySelectorAll(".tab")
          .forEach((tab) => tab.classList.remove("active"));
        document
          .querySelectorAll(".tab-content")
          .forEach((content) => content.classList.remove("active"));

        document
          .querySelector(`.tab[onclick="switchTab('${tabId}')"]`)
          .classList.add("active");
        document.getElementById(tabId).classList.add("active");

        if (tabId === "scheduled") {
          fetchJobs();
        }
      }

      // Show message to user
      function showMessage(message, type) {
        const messageContainer = document.getElementById("message-container");
        messageContainer.innerHTML = `<div class="message ${type}">${message}</div>`;

        // Clear the message after 5 seconds
        setTimeout(() => {
          messageContainer.innerHTML = "";
        }, 5000);
      }

      // Handle one-time email form submission
      document
        .getElementById("one-time-form")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          const recipients = document.getElementById(
            "one-time-recipients"
          ).value;
          const subject = document.getElementById("one-time-subject").value;
          const text = document.getElementById("one-time-body").value;
          const date = document.getElementById("one-time-date").value;
          const time = document.getElementById("one-time-time").value;

          const scheduleTime = `${date} ${time}`;

          try {
            const response = await fetch("/schedule", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                recipients,
                subject,
                text,
                scheduleTime,
              }),
            });

            const data = await response.json();

            if (response.ok) {
              showMessage(
                `Email scheduled successfully for ${new Date(
                  data.scheduledUTC
                ).toLocaleString()}`,
                "success"
              );
              document.getElementById("one-time-form").reset();
            } else {
              showMessage(`Error: ${data.message}`, "error");
            }
          } catch (error) {
            showMessage(`Error: ${error.message}`, "error");
          }
        });

      // Handle recurring email form submission
      document
        .getElementById("recurring-form")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          const recipients = document.getElementById(
            "recurring-recipients"
          ).value;
          const subject = document.getElementById("recurring-subject").value;
          const text = document.getElementById("recurring-body").value;
          const startDate = document.getElementById(
            "recurring-start-date"
          ).value;
          const startTime = document.getElementById(
            "recurring-start-time"
          ).value;
          const recurrencePattern =
            document.getElementById("recurring-pattern").value;
          const endDate = document.getElementById("recurring-end-date").value;
          const endTime = document.getElementById("recurring-end-time").value;
          const maxOccurrences = document.getElementById("recurring-max").value;

          const startTimeStr = `${startDate} ${startTime}`;
          const endTimeStr =
            endDate && endTime ? `${endDate} ${endTime}` : null;

          try {
            const response = await fetch("/schedule-recurring", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                recipients,
                subject,
                text,
                startTime: startTimeStr,
                recurrencePattern,
                endTime: endTimeStr,
                maxOccurrences: maxOccurrences
                  ? parseInt(maxOccurrences)
                  : null,
              }),
            });

            const data = await response.json();

            if (response.ok) {
              showMessage(
                `Recurring email scheduled successfully starting at ${new Date(
                  data.startTime
                ).toLocaleString()}`,
                "success"
              );
              document.getElementById("recurring-form").reset();
            } else {
              showMessage(`Error: ${data.message}`, "error");
            }
          } catch (error) {
            showMessage(`Error: ${error.message}`, "error");
          }
        });

      // Fetch scheduled jobs
      async function fetchJobs() {
        try {
          const response = await fetch("/jobs");
          const data = await response.json();

          const jobsList = document.getElementById("jobs-list");
          jobsList.innerHTML = "";

          if (data.jobs.length === 0) {
            jobsList.innerHTML =
              '<tr><td colspan="4">No scheduled emails found</td></tr>';
            return;
          }

          data.jobs.forEach((job) => {
            const row = document.createElement("tr");

            const idCell = document.createElement("td");
            idCell.textContent = job.jobId;

            const typeCell = document.createElement("td");
            typeCell.textContent = job.type;

            const timeCell = document.createElement("td");
            timeCell.textContent =
              job.nextInvocation !== "No pending invocations"
                ? new Date(job.nextInvocation).toLocaleString()
                : "No pending invocations";

            const actionCell = document.createElement("td");
            const cancelButton = document.createElement("button");
            cancelButton.textContent = "Cancel";
            cancelButton.style.backgroundColor = "#dc3545";
            cancelButton.onclick = () => cancelJob(job.jobId);
            actionCell.appendChild(cancelButton);

            row.appendChild(idCell);
            row.appendChild(typeCell);
            row.appendChild(timeCell);
            row.appendChild(actionCell);

            jobsList.appendChild(row);
          });
        } catch (error) {
          showMessage(`Error fetching jobs: ${error.message}`, "error");
        }
      }

      // Cancel a scheduled job
      async function cancelJob(jobId) {
        try {
          const response = await fetch(`/cancel/${jobId}`, {
            method: "DELETE",
          });

          const data = await response.json();

          if (response.ok) {
            showMessage(`Job ${jobId} cancelled successfully`, "success");
            fetchJobs();
          } else {
            showMessage(`Error: ${data.message}`, "error");
          }
        } catch (error) {
          showMessage(`Error: ${error.message}`, "error");
        }
      }

      // Refresh jobs list
      document
        .getElementById("refresh-jobs")
        .addEventListener("click", fetchJobs);

      // Initial fetch of jobs when the page loads
      document.addEventListener("DOMContentLoaded", () => {
        const urlParams = new URLSearchParams(window.location.search);
        const tab = urlParams.get("tab");

        if (tab) {
          switchTab(tab);
        }
      });
    </script>
  </body>
</html>